version: "3.9"

name: vts

networks:
  vts_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

volumes:
  backend_data:
    driver: local

services:
  backend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend
    image: vts-backend:latest
    container_name: vts-backend
    networks:
      vts_net:
        ipv4_address: 172.25.0.10
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_NICE
    ulimits:
      rtprio: 95
      memlock: -1
    environment:
      - IF_NAME=${IF_NAME:-eth0}
      - API_PORT=8081
      - WS_PORT=8082
      - TZ=UTC
    volumes:
      - backend_data:/app/data
    ports:
      - "8080:8081"
      - "8090:8082"
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8081"]
      interval: 10s
      timeout: 2s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    profiles:
      - dev

  frontend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.frontend
    image: vts-frontend:latest
    container_name: vts-frontend
    depends_on:
      backend:
        condition: service_healthy
    networks:
      vts_net:
        ipv4_address: 172.25.0.20
    ports:
      - "5173:80"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost/"]
      interval: 10s
      timeout: 2s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    profiles:
      - dev

  # Real-time profile - uses host network for minimum latency
  backend-rt:
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend
    image: vts-backend:latest
    container_name: vts-backend-rt
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_NICE
      - IPC_LOCK
    ulimits:
      rtprio: 99
      memlock: -1
    security_opt:
      - seccomp:unconfined
    environment:
      - IF_NAME=${IF_NAME:-eth0}
      - API_PORT=8080
      - WS_PORT=8090
      - TZ=UTC
      - RT_PRIORITY=80
    volumes:
      - backend_data:/app/data
      - /sys/fs/cgroup:/sys/fs/cgroup:ro
    restart: unless-stopped
    profiles:
      - rt

  frontend-rt:
    build:
      context: ..
      dockerfile: docker/Dockerfile.frontend
    image: vts-frontend:latest
    container_name: vts-frontend-rt
    network_mode: host
    restart: unless-stopped
    profiles:
      - rt
